import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";

export const theme = vsDark;

# Hello ðŸ‘‹ I'm Daniel

Senior Front-End Engineer @ H-E-B Digital

---

# Server Side Rendering
- Why SSR?
- SSR at H-E-B Digital
- How to SSR your app


---

# Why Sever Side Render?

---

# Progressive Enhancement
- Resolve your data internally   
- Ship only what the client needs
- Defer javascript parsing after rendering

---

# Tools for SSR
- Webpack Code Splitting
- Univeral Components
- Flush Chunks
- Styled Components
- Helmet

---

# SSR at H-E-B Digital 

Decoupling our Java Monolith

---

# Component Rendering Service
- API for SSR React components
- Shared redux context
- Reusable components
- Decoupled from our Java Application

---

# Single Page Application
- Full Routes with Code Splitting
- Same components as rendering service
- Decoupled from our Java Application

---

# How It's Done

---

<CodeSurfer>

```js title="React Makes it Easy"
  const App = TODO
```

</CodeSurfer>

---

<CodeSurfer>

```js title="React Makes it Easy"
  const application = ReactDOM.renderToString(
    <App />
  );
```

```js title="Add Redux"
  import { createStore } from 'store/create';

  const store = createStore();

  const application = ReactDOM.renderToString(
    <App store={store} />
  );

  const state = store.getState();

```

```js title="Collect Styles"
  import { createStore } from 'store/create';
  import { ServerStyleSheet } from "styled-components";
  
  const store = createStore();
  const sheet = new ServerStyleSheet();

  const application = ReactDOM.renderToString(
    sheet.collectStyles(
      <App store={store} />
    )
  );

  const state = store.getState();
  const styles = sheet.getStyleTags();

```

```js title="Collect Javascript"
  import { createStore } from 'store/create';
  import { ServerStyleSheet } from "styled-components";
  import flushChunks from 'webpack-flush-chunks';
  import { flushChunkNames } from 'react-universal-component/server';

  const store = createStore();
  const sheet = new ServerStyleSheet();

  const application = ReactDOM.renderToString(
    sheet.collectStyles(
      <App store={store} />
    )
  );

  const state = store.getState();
  const styles = sheet.getStyleTags();

  const chunkNames = flushChunkNames();
  const { js } = flushChunks(clientStats, { chunkNames });

```

```js title="Build your document"
  import { createStore } from 'store/create';
  import { ServerStyleSheet } from "styled-components";
  import flushChunks from 'webpack-flush-chunks';
  import { flushChunkNames } from 'react-universal-component/server';

  const store = createStore();
  const sheet = new ServerStyleSheet();

  const application = ReactDOM.renderToString(
    sheet.collectStyles(
      <App store={store} />
    )
  );

  const state = store.getState();
  const styles = sheet.getStyleTags();

  const chunkNames = flushChunkNames();
  const { js } = flushChunks(clientStats, { chunkNames });

  return `<!doctype html>
    <html>
      <head>
        <title>My Application</title>
        ${styles}
      </head>
      <body>
        <div id="root">${application}</div>
        <script type="text/javascript">
          window.__PRELOADED_STATE__ = ${JSON.stringify(state).replace(/</g, '\\u003c')};
        </script>
        ${js}
      </body>
    </html>`;

```

```js title="MEMORY LEAKS!!!!" 4[11:23],7,21:22
  import { createStore } from 'store/create';
  import { ServerStyleSheet } from "styled-components";
  import flushChunks from 'webpack-flush-chunks';
  import { clearChunks, flushChunkNames } from 'react-universal-component/server';

  const store = createStore();
  const sheet = new ServerStyleSheet();

  const application = ReactDOM.renderToString(
    sheet.collectStyles(
      <App store={store} />
    )
  );

  const state = store.getState();
  const styles = sheet.getStyleTags();

  const chunkNames = flushChunkNames();
  const { js } = flushChunks(clientStats, { chunkNames });

  sheet.seal();
  clearChunks();

  return `<!doctype html>
    <html>
      <head>
        <title>My Application</title>
        ${styles}
      </head>
      <body>
        <div id="root">${application}</div>
        <script type="text/javascript">
          window.__PRELOADED_STATE__ = ${JSON.stringify(state).replace(/</g, '\\u003c')};
        </script>
        ${js}
      </body>
    </html>`;

```


```js title="Data Fetching with Apollo Client"
  import { createStore } from 'store/create';
  import { createClient } from 'client/create';
  import { ServerStyleSheet } from "styled-components";
  import flushChunks from 'webpack-flush-chunks';
  import { clearChunks, flushChunkNames } from 'react-universal-component/server';

  const client = createClient();
  const store = createStore();
  const sheet = new ServerStyleSheet();

  await getDataFromTree(App);

  const application = ReactDOM.renderToString(
    sheet.collectStyles(
      <App store={store} apolloClient={client} />
    )
  );

  const apolloState = client.extract();
  const state = store.getState();
  const styles = sheet.getStyleTags();

  const chunkNames = flushChunkNames();
  const { js } = flushChunks(clientStats, { chunkNames });

  sheet.seal();
  clearChunks();

  return `<!doctype html>
    <html>
      <head>
        <title>My Application</title>
        ${styles}
      </head>
      <body>
        <div id="root">${application}</div>
        <script type="text/javascript">
          window.__PRELOADED_STATE__ = ${JSON.stringify(state).replace(/</g, '\\u003c')};
          window.__APOLLO_STATE__ = ${JSON.stringify(apolloState).replace(/</g, '\\u003c')};
        </script>
        ${js}
      </body>
    </html>`;

```

</CodeSurfer>

---

<CodeSurfer>

```js title="This is a title" subtitle="and this a subtitle"
function lorems(ipsum, dolor = 1) {
  const sit = ipsum == null ? 0 : ipsum.sit;
  dolor = sit - amet(dolor);
  return sit
    ? consectetur(ipsum, 0, dolor < 0 ? 0 : dolor)
    : [];
}

function incididunt(ipsum, ut = 1) {
  ut = labore.et(amet(ut), 0);
  const sit = ipsum == null ? 0 : ipsum.sit;

  if (!sit || ut < 1) {
    return [];
  }

  let dolore = 0;
  let magna = 0;
  const aliqua = new eiusmod(labore.ut(sit / ut));

  while (dolore < sit) {
    aliqua[magna++] = consectetur(
      ipsum,
      dolore,
      (dolore += ut)
    );
  }

  return aliqua;
}
```

```js
function lorem(ipsum, dolor = 1) {
  const sit = ipsum == null ? 0 : ipsum.sit;
  dolor = sit - amet(dolor);
  return sit
    ? consectetur(ipsum, 0, dolor < 0 ? 0 : dolor)
    : [];
}

function adipiscing(...elit) {
  if (!elit.sit) {
    return [];
  }

  const sed = elit[0];
  return eiusmod.tempor(sed) ? sed : [sed];
}

function incididunt(ipsum, ut = 1) {
  ut = labore.et(amet(ut), 0);
  const sit = ipsum == null ? 0 : ipsum.sit;

  if (!sit || ut < 1) {
    return [];
  }

  let dolore = 0;
  let magna = 0;
  const aliqua = new eiusmod(labore.ut(sit / ut));

  while (dolore < sit) {
    aliqua[magna++] = consectetur(
      ipsum,
      dolore,
      (dolore += ut)
    );
  }

  return aliqua;
}
```

```diff 1[10:14],2[15:19],3[22:27],10:12

```

</CodeSurfer>

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js
const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);
```

</Step>

<Step>

```js
const lorem = (ipsum, dolor, sit) => {
  const amet = dolor - ipsum;
  return consectetur.adipiscing(
    {
      elit: sed.eiusmod(sit - dolor) / amet + 2,
    },
    (tempor, incididunt) => ipsum + amet * incididunt
  );
};

const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);

const sed = (eiusmod, tempor, incididunt) => {
  const ut = tempor - eiusmod;
  return labore.et(
    {
      amet: dolore.magna(incididunt - tempor) / ut + 2,
    },
    (aliqua, elit) => eiusmod + ut * elit
  );
};
```

</Step>

</CodeSurferColumns>

---

docs:  
[codesurfer.pomb.us](https://codesurfer.pomb.us)
